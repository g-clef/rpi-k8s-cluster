# Completely disable DNS function
port=0

# Only bind to our specific interface, never localhost
interface={{ net_iface }}
bind-dynamic
except-interface=lo

# Only listen on the interface, not specific IPs
no-dhcp-interface=lo

# Disable all default behaviors that might bind to localhost  
no-hosts
no-resolv
no-poll

# DHCP only on our interface
dhcp-range=interface:{{ net_iface }},{{ dhcp_start }},{{ dhcp_end }},12h
dhcp-option=3,{{ router_ip }}
dhcp-option=6,{{ dns_servers }}
log-dhcp

# TFTP configuration
enable-tftp
tftp-root={{ tftp_root }}

# Pi4 architecture matching
dhcp-match=set:rpi4,option:client-arch,29
dhcp-match=set:rpi4,option:client-arch,11

# Boot configuration for RPi netboot
dhcp-option=tag:rpi4,option:bootfile-name,start4.elf
dhcp-option=tag:rpi4,option:tftp-server,{{ ansible_default_ipv4.address | default('192.168.1.50') }}

# Static DHCP leases for Raspberry Pis with individual boot paths
{% for host in groups['pi_servers'] + groups['pi_agents'] %}
dhcp-host={{ hostvars[host].mac | lower }},{{ hostvars[host].ip }},set:rpi4,set:{{ hostvars[host].hostname }}
dhcp-option=tag:{{ hostvars[host].hostname }},option:bootfile-name,{{ hostvars[host].mac | lower | replace(':','-') }}/start4.elf
{% endfor %}
