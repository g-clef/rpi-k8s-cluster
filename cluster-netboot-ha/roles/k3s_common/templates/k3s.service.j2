[Unit]
Description=k3s {% if inventory_hostname in groups['pi_servers'] %}server{% if inventory_hostname == groups['pi_servers'][0] %} (cluster-init){% else %} (join){% endif %}{% else %}agent{% endif %}
After=network-online.target
Wants=network-online.target

[Service]
Type={% if inventory_hostname in groups['pi_servers'] %}notify{% else %}simple{% endif %}
{% if inventory_hostname in groups['pi_servers'] %}
Environment="INSTALL_K3S_VERSION={{ k3s_version }}"
Environment="K3S_TOKEN={{ cluster_token }}"
{% if inventory_hostname != groups['pi_servers'][0] %}
Environment="K3S_URL=https://pi01:6443"
{% endif %}
Environment="K3S_KUBECONFIG_MODE=644"
ExecStart=/bin/sh -c 'curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${INSTALL_K3S_VERSION} sh -s - server {% if inventory_hostname == groups['pi_servers'][0] %}--cluster-init{% endif %} --cluster-cidr {{ cluster_cidr }} --service-cidr {{ service_cidr }} --disable traefik'
{% else %}
Environment="K3S_URL=https://pi01:6443"
Environment="K3S_TOKEN={{ cluster_token }}"
Environment="K3S_NODE_NAME=%H"
ExecStart=/bin/sh -c 'curl -sfL https://get.k3s.io | sh -s - agent'
{% endif %}
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
