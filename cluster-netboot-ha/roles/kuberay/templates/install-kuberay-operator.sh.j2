#!/bin/bash
set -e

echo "Waiting for k3s to be ready..."
for i in $(seq 1 60); do
    /usr/local/bin/k3s kubectl get nodes && break || sleep 10
done

echo "Installing KubeRay operator..."
/usr/local/bin/k3s kubectl apply -f /tmp/kuberay/kuberay-operator.yaml

echo "Waiting for KubeRay operator to be ready..."
for i in $(seq 1 60); do
    if /usr/local/bin/k3s kubectl get deployment kuberay-operator -n ray-system >/dev/null 2>&1; then
        if /usr/local/bin/k3s kubectl rollout status deployment/kuberay-operator -n ray-system --timeout=10s >/dev/null 2>&1; then
            echo "KubeRay operator is ready!"
            break
        fi
    fi
    echo "Waiting for KubeRay operator... ($i/60)"
    sleep 10
done

echo "KubeRay operator installation complete!"
echo "Ray clusters will be managed via ArgoCD from the configured Git repository."
